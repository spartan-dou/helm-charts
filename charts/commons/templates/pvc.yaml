{{- $components := include "commons.withAddons" . | fromYamlArray }}
{{- range $components }}
{{- $component := . }}
{{- range $component.deployment.volumes }}
{{- $volume := . }}
{{- $pvc := $volume.pvc }}
{{- if and $pvc (not $pvc.useExisting) }}
apiVersion: v1
kind: PersistentVolumeClaim
metadata:
  name: {{ include "commons.fullname" (dict "Chart" $.Chart "Values" $.Values "Release" $.Release "name" (default $volume.name $pvc.name) "component" $component) }}
  labels:
    {{ include "commons.labels" (dict "Chart" $.Chart "Values" $.Values "Release" $.Release "name" (default $volume.name $pvc.name) "component" $component) | nindent 4 }}
spec:
  accessModes:
    - {{ ($pvc.storage | default dict).accessMode | default $.Values.global.pvc.storage.accessMode }}
  resources:
    requests:
      storage: {{ ($pvc.storage | default dict).size | default $.Values.global.pvc.storage.size }}
  storageClassName: {{ ($pvc.storage | default dict).storageClass | default $.Values.global.pvc.storage.storageClass }}
  {{- if and $pvc.storage $pvc.storage.volumeMode }}
  volumeMode: {{ $pvc.storage.volumeMode }}
  {{- end }}
  {{- if and $pvc.storage $pvc.storage.selector }}
  selector:
    {{- toYaml $pvc.storage.selector | nindent 4 }}
  {{- end }}
---
{{- end }}
{{- end }}
{{- end }}
