global:
  timezone: "Europe/Paris"
  securityContext:
    runAsUser: 1000
    runAsGroup: 1000
    fsGroup: 1000
  pvc:
    storage:
      size: "1Gi"
      storageClassName: "test"
  postgres:
    storage:
      size: "1Gi"
      storageClass: "test"
    image:
      repository: ghcr.io/cloudnative-pg/postgresql
      tag: 16
  ingress:
    className: traefik
  rbac:
    enabled: true
    clusterRoleName: homepage
    serviceAccountName: homepage
    rules:
      - apiGroups: [""]
        resources: ["namespaces", "pods", "nodes"]
        verbs: ["get", "list"]
      - apiGroups: ["extensions", "networking.k8s.io"]
        resources: ["ingresses"]
        verbs: ["get", "list"]
      - apiGroups: ["traefik.io"]
        resources: ["ingressroutes"]
        verbs: ["get", "list"]
      - apiGroups: ["gateway.networking.k8s.io"]
        resources: ["httproutes", "gateways"]
        verbs: ["get", "list"]
      - apiGroups: ["metrics.k8s.io"]
        resources: ["nodes", "pods"]
        verbs: ["get", "list"]

components:
  - name: nginx
    deployment:
      replicas: 2
      initContainers:
        containers:
          - name: setup-volume
            image:
              repository: alpine
            command: ['sh', '-c', 'mkdir -p /data/init']
      image: 
        repository: nginx
        tag: latest
      ports:
        - name: http
          containerPort: 80
      env:
        - name: ENV
          value: prod
        - name: postgres_username
          value: __components__postgres__username
        - name: postgres_username
          valueFrom:
            secretKeyRef:
              name: __components__postgres__password_secret
              key: password
      livenessProbe:
        httpGet:
          path: /health
          port: 8080
        initialDelaySeconds: 10
        periodSeconds: 5
      readinessProbe:
        httpGet:
          path: /ready
          port: 8080
        initialDelaySeconds: 5
        periodSeconds: 3
      startupProbe:
        httpGet:
          path: /startup
          port: 8080
        failureThreshold: 30
        periodSeconds: 10
      volumeMounts:
        - name: config
          mountPath: /etc/config
      volumes:
        - name: data
          persistentVolumeClaim:
            claimName: __components__pvc__data-pvc
            subPath: data
    service:
      enabled: true
      type: ClusterIP
      annotations:
        metallb.universe.tf/address-pool: "default"
        prometheus.io/scrape: "true"
      ports:
        - name: http
          port: 80
          targetPort: 8080
    ingress:
      enabled: true
      className: traefik
      annotations:
        nginx.ingress.kubernetes.io/rewrite-target: /
      hosts:
        - host: web.mondomaine.local
          paths:
            - path: /
              pathType: Prefix
      tls:
        - hosts:
            - web.mondomaine.local
          secretName: web-cert
    pvc:
      - name: data-pvc
        accessMode: ReadWriteOnce
        storage: 1Gi
        storageClassName: local-path
      - name: data-2-pvc
        accessMode: ReadWriteOnce
        storage: 2Gi
        storageClassName: local-path
    configMap:
      - name: config
        data:
          config.yaml: |
            key: value
          toto.yaml: |
            foo: bar
            user: titi
    postgres:
      enabled: true
      image:
        tag: 16
      storage:
        size: 1Gi
        storageClass: local-path
      cluster:
        username: changeme
        password: changeme
      postInitTemplateSQL:
        - CREATE EXTENSION postgis;
        - CREATE EXTENSION postgis_topology;
        - CREATE EXTENSION fuzzystrmatch;
        - CREATE EXTENSION postgis_tiger_geocoder;

addons:
  vscode:
    enabled: true
    image:
      repository: codercom/code-server
      tag: 39
    port: 8080
    ingress:
      enabled: false
  redis:
    enabled: true
    name: redis
    image:
      repository: bitnami/redis
      tag: 8.2.1
    port: 6379
    password: changeme
  postgres:
    enabled: true
    storage:
      size: "1Gi"
      storageClass: "test"
    cluster:
      username: changeme
      password: changeme