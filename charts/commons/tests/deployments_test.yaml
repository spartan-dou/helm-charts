# yaml-language-server: $schema=https://raw.githubusercontent.com/helm-unittest/helm-unittest/main/schema/helm-testsuite.json
suite: Tests complets du chart commons
values:
  - ./values/values.yaml
templates:
  - templates/deployment.yaml
release:
  name: test
tests:
 # --- Deployments ---
  - it: Vérifie le Deployment web
    documentSelector:
      path: metadata.name
      value: test-nginx
    asserts:
      - equal:
          path: spec.replicas
          value: 2
      - equal:
          path: spec.template.spec.containers[0].image
          value: nginx:latest
      - equal:
          path: spec.template.spec.securityContext.runAsUser
          value: 80
      - equal:
          path: spec.template.spec.containers[0].securityContext.runAsUser
          value: 20
      - equal:
          path: spec.template.spec.securityContext.runAsGroup
          value: 1001
      - equal:
          path: spec.template.spec.securityContext.supplementalGroups[0]
          value: 10
      - equal:
          path: spec.template.spec.initContainers[0].name
          value: setup-volume
      - equal:
          path: spec.template.spec.initContainers[1].name
          value: wait-for-redis
      - equal:
          path: spec.template.spec.initContainers[2].name
          value: wait-for-postgres
      - equal:
          path: spec.template.spec.initContainers[3].name
          value: wait-for-postgres-nginx

  - it: Vérifie les variables d'env
    documentSelector:
      path: metadata.name
      value: test-nginx
    asserts:
      - equal:
          path: spec.template.spec.containers[0].env[0].value
          value: Europe/Paris
      - equal:
          path: spec.template.spec.containers[0].env[1].value
          value: prod
      - equal:
          path: spec.template.spec.containers[0].env[2].value
          value: changeme
      - equal:
          path: spec.template.spec.containers[0].env[3].valueFrom.secretKeyRef.name
          value: test-nginx-postgres-secret

  - it: Vérifie les prots
    documentSelector:
      path: metadata.name
      value: test-nginx
    asserts:
      - equal:
          path: spec.template.spec.containers[0].ports[0].name
          value: http
      - equal:
          path: spec.template.spec.containers[0].ports[0].containerPort
          value: 80
      - equal:
          path: spec.template.spec.containers[0].ports[1].name
          value: http2
      - equal:
          path: spec.template.spec.containers[0].ports[1].containerPort
          value: 8080

  - it: Vérifie les volumes
    documentSelector:
      path: metadata.name
      value: test-nginx
    asserts:
      - equal:
          path: spec.template.spec.volumes[0].persistentVolumeClaim.claimName
          value: test-nginx-data-pvc
      - equal:
          path: spec.template.spec.containers[0].volumeMounts[0].subPath
          value: data
  - it: Vérifie le Deployment vscode
    documentSelector:
      path: metadata.name
      value: test-code-server
    asserts:
      - equal:
          path: spec.replicas
          value: 1
      - equal:
          path: spec.template.spec.securityContext.runAsUser
          value: 1000
      - equal:
          path: spec.template.spec.securityContext.runAsGroup
          value: 1001
      - equal:
          path: spec.template.spec.containers[0].image
          value: lscr.io/linuxserver/code-server:4.104.2
      - equal:
          path: spec.template.spec.containers[0].volumeMounts[0].mountPath
          value: "/config"
      - equal:
          path: spec.template.spec.containers[0].volumeMounts[0].name
          value: "vscode-config"
      - equal:
          path: spec.template.spec.volumes[0].name
          value: "vscode-config"
      - equal:
          path: spec.template.spec.volumes[0].persistentVolumeClaim.claimName
          value: "test-code-server-vscode-config"
      - equal:
          path: spec.template.spec.containers[0].volumeMounts[1].mountPath
          value: "/config/workspace/toto"
      - equal:
          path: spec.template.spec.containers[0].volumeMounts[1].name
          value: "toto"
      - equal:
          path: spec.template.spec.volumes[1].name
          value: "toto"
      - equal:
          path: spec.template.spec.volumes[1].persistentVolumeClaim.claimName
          value: "test-nginx-data-2-pvc"

  - it: Vérifie le Deployment redis
    documentSelector:
      path: metadata.name
      value: test-redis
    asserts:
      - equal:
          path: spec.replicas
          value: 1
      - equal:
          path: spec.template.spec.securityContext.runAsUser
          value: 1000
      - notExists:
          path: spec.template.spec.containers[0].securityContext.runAsUser
      - equal:
          path: spec.template.spec.containers[0].image
          value: redis:8.2.1

  - it: ne doit pas créer le Service Redis si désactivé
    set:
      addons:
        redis:
          enabled: false
    asserts:
      - hasDocuments:
          count: 3

  - it: ne doit pas créer le Service Vscode si désactivé
    set:
      addons:
        vscode:
          enabled: false
    asserts:
      - hasDocuments:
          count: 3