suite: Tests complets du chart commons
templates:
  - templates/addons/redis/secret.yaml
  - templates/cnpg/secret.yaml
  - templates/cnpg/init-sql.yaml
  - templates/pvc.yaml
  - templates/services.yaml
  - templates/deployment.yaml
  - templates/ingress.yaml
  - templates/cnpg/cluster.yaml

tests:
  # --- Secrets ---
  - it: Vérifie le Secret Redis
    asserts:
      - equal:
          path: metadata.name
          value: test-commons-secret
      - equal:
          path: type
          value: Opaque
      - equal:
          path: data.password
          value: Y2hhbmdlbWU=

  - it: Vérifie le Secret Postgres
    documentIndex: 1
    asserts:
      - equal:
          path: metadata.name
          value: test-postgres-secret
      - equal:
          path: type
          value: kubernetes.io/basic-auth
      - equal:
          path: data.username
          value: Y2hhbmdlbWU=
      - equal:
          path: data.password
          value: Y2hhbmdlbWU=

  # --- ConfigMap ---
  - it: Vérifie le ConfigMap init-sql
    documentIndex: 2
    asserts:
      - equal:
          path: metadata.name
          value: test-postgres
      - matchRegex:
          path: data.init.sql
          pattern: "toto"

  # --- PVC ---
  - it: Vérifie le PVC web-data
    documentIndex: 3
    asserts:
      - equal:
          path: metadata.name
          value: web-data
      - equal:
          path: spec.accessModes[0]
          value: ReadWriteOnce
      - equal:
          path: spec.resources.requests.storage
          value: 1Gi
      - equal:
          path: spec.storageClassName
          value: local-path

  # --- Services ---
  - it: Vérifie le Service web
    documentIndex: 4
    asserts:
      - equal:
          path: metadata.name
          value: test-commons
      - equal:
          path: spec.ports[0].port
          value: 80
      - equal:
          path: spec.ports[0].targetPort
          value: 8080
      - equal:
          path: spec.selector.app
          value: web

  - it: Vérifie le Service vscode
    documentIndex: 5
    asserts:
      - equal:
          path: metadata.name
          value: test-commons-vscode
      - equal:
          path: spec.ports[0].port
          value: 8080
      - equal:
          path: spec.selector.app
          value: vscode

  - it: Vérifie le Service redis
    documentIndex: 6
    asserts:
      - equal:
          path: metadata.name
          value: test-commons-redis
      - equal:
          path: spec.ports[0].port
          value: 6379
      - equal:
          path: spec.selector.app
          value: redis

  # --- Deployments ---
  - it: Vérifie le Deployment web
    documentIndex: 7
    asserts:
      - equal:
          path: metadata.name
          value: test-commons
      - equal:
          path: spec.replicas
          value: 2
      - equal:
          path: spec.template.spec.containers[0].image
          value: nginx:latest
      - equal:
          path: spec.template.spec.initContainers[0].name
          value: wait-for-redis

  - it: Vérifie le Deployment vscode
    documentIndex: 8
    asserts:
      - equal:
          path: metadata.name
          value: test-commons
      - equal:
          path: spec.replicas
          value: 1
      - equal:
          path: spec.template.spec.containers[0].image
          value: codercom/code-server:39

  - it: Vérifie le Deployment redis
    documentIndex: 9
    asserts:
      - equal:
          path: metadata.name
          value: test-commons
      - equal:
          path: spec.replicas
          value: 1
      - equal:
          path: spec.template.spec.containers[0].image
          value: bitnami/redis:8.2.1

  # --- Ingress ---
  - it: Vérifie l'Ingress web
    documentIndex: 10
    asserts:
      - equal:
          path: metadata.name
          value: test-commons
      - equal:
          path: spec.rules[0].host
          value: web.mondomaine.local
      - equal:
          path: spec.tls[0].secretName
          value: web-cert

  # --- Cluster CNPG ---
  - it: Vérifie le Cluster Postgres
    documentIndex: 11
    asserts:
      - equal:
          path: metadata.name
          value: postgres
      - equal:
          path: spec.instances
          value: 1
      - equal:
          path: spec.imageName
          value: ghcr.io/cloudnative-pg/postgresql:16
