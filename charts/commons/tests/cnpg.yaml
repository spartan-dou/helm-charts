suite: Tests complets du chart commons
templates:
  - templates/cnpg/cluster.yaml
  - templates/cnpg/init-sql.yaml
  - templates/cnpg/secret.yaml

tests:
  # --- Cluster CNPG ---
  - it: Vérifie le Cluster Postgres
    documentSelector:
      kind: Cluster
      metadata:
        name: postgres
    asserts:
      - equal:
          path: spec.instances
          value: 1
      - equal:
          path: spec.imageName
          value: ghcr.io/cloudnative-pg/postgresql:16

  # --- Secret ---
  - it: Vérifie le Secret Postgres
    documentSelector:
      kind: Secret
      metadata:
        name: test-postgres-secret
    asserts:
      - equal:
          path: type
          value: kubernetes.io/basic-auth
      - equal:
          path: data.username
          value: Y2hhbmdlbWU=
      - equal:
          path: data.password
          value: Y2hhbmdlbWU=

  # --- ConfigMap ---
  - it: Vérifie le ConfigMap init-sql
    documentSelector:
      kind: ConfigMap
      metadata:
        name: test-postgres
    asserts:
      - matchRegex:
          path: data.init.sql
          pattern: "toto"
