# yaml-language-server: $schema=https://raw.githubusercontent.com/helm-unittest/helm-unittest/main/schema/helm-testsuite.json
suite: Tests complets du chart commons
values:
  - ./values/values.yaml
release:
  name: test
tests:
 # --- Deployments ---
  - it: Vérifie le PgDeployement
    documentSelector:
      path: metadata.name
      value: test-pgadmin-pg-config
    templates:
      - templates/configmap.yaml
    asserts:
      - equal:
          path: data["servers.json"]
          value: |-
            {
              "Servers": {
                "0": {
                  "Name": "nginx",
                  "Group": "test",
                  "Port": 5432,
                  "Username": "changeme",
                  "Host": "test-nginx-postgres-rw",
                  "MaintenanceDB": "postgres"
                },
                "1": {
                  "Name": "postgres",
                  "Group": "test",
                  "Port": 5432,
                  "Username": "changeme",
                  "Host": "test-postgres-rw",
                  "MaintenanceDB": "postgres"
                }
              }
            }

  - it: Vérifie le PgDeployement
    documentSelector:
      path: metadata.name
      value: test-pgadmin
    templates:
      - templates/deployment.yaml
    asserts:
      - equal:
          path: spec.template.spec.containers[0].image
          value: dpage/pgadmin4:9.8.0
      - equal:
          path: spec.template.spec.volumes[0].name
          value: config

  - it: Vérifie le PgDeployement service
    documentSelector:
      path: metadata.name
      value: test-pgadmin
    templates:
      - templates/service.yaml
    asserts:
      - equal:
          path: spec.ports[0].port
          value: 80